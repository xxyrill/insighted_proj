{% extends 'components/layouts.html' %}

{% load static %} <!-- Filter Form -->

{% block content %}
{% include 'dashboard/upload_data.html' %}
<div class="container-fluid pt-4">
  {% if messages %}
      <div class="alert-container" id="message-container">
          {% for message in messages %}
              <div class="alert alert-success fade-out">{{ message }}</div>
          {% endfor %}
      </div>
  {% endif %}
  <div class="row">
    <div class="col-md-4">
      <div class="card shadow rounded d-flex justify-content-center align-items-center">
        <div class="card-body w-100" style="height: 700px;" >
          <div class="container-fluid text-center">
            <h5 class="card-title text-center font-weight-bold">Filters</h5>
            <!-- Filter Form -->
            <form method="GET" action="{% url 'generate_graph' %}">
              <!-- Graph Select -->
              <div class="form-group">
                <label for="graph">Graph:</label>
                <select class="form-control" id="graph" name="graph">
                  <option value="all"></option>
                  <option value="ratings_trend">Ratings Trend</option>
                  <option value="department_avg_ratings">Department Average Ratings</option>
                  <option value="rating_distribution">Rating Distribution</option>
                  <option value="word_clouds">Word Clouds</option>
                  <option value="comment_lengths">Comment Lengths</option>
                  <option value="ratings_by_course">Ratings by Course</option>
                  <option value="correlation_heatmap">Correlation by Heatmap</option>
                  <option value="performance_year_department">Performance by Year and Department</option>
                  <option value="sentiment_over_time">Sentiment Over Time</option>
                  <option value="instructor_performance_time">Instructor Performance Over Time</option>
                  <option value="pareto_analysis">Pareto Analysis</option>
                  <option value="ratings_vs_comment_length">Ratings VS Comment Length</option>
                  <option value="instructor_comparison_dashboard">Instructor Comparison Dashboard</option>
                </select>
              </div>

<!-- Department Select -->
<div class="form-group">
    <label for="department">Department:</label>
    <select class="form-control" id="department" name="department">
        <option value="All Departments"></option>
        {% for department in departments %}
            <option value="{{ department }}">{{ department }}</option>
        {% empty %}
            <option value="">No departments available</option>
        {% endfor %}
    </select>
</div>

<!-- Instructor Select -->
<div class="form-group">
    <label for="instructor">Instructor:</label>
    <select class="form-control" id="instructor" name="instructor">
        <option value="Respective Facilitator"></option>
        {% for instructor in instructors %}
            <option value="{{ instructor }}">{{ instructor }}</option>
        {% empty %}
            <option value="">No instructors available</option>
        {% endfor %}
    </select>
</div>

<!-- Course Select -->
<div class="form-group">
    <label for="course">Course:</label>
    <select class="form-control" id="course" name="course">
        <option value="All Courses"></option>
        {% for course in courses %}
            <option value="{{ course }}">{{ course }}</option>
        {% empty %}
            <option value="">No courses available</option>
        {% endfor %}
    </select>
</div>
</form>
              <!-- Filter and Clear Filters Buttons -->

 <div class="d-flex justify-content-between">
     <button type="submit" class="btn btn-primary" style="width: 10rem">Filter</button>
     <button type="button" id="clear-filters-btn" class="btn btn-secondary" style="width: 10rem">Clear Filters</button>
 </div>
            </form>

            <!-- Upload and View Data Buttons -->
            <div class="mt-4 text-center">
              {% if user_type == 'VPAA' %}
              <button type="button"
                      class="btn btn-primary btn-block"
                      data-toggle="modal"
                      data-target="#uploadDataModal"
                      data-backdrop="false">
                Upload Data
              </button>
              {% endif %}
              <button type="button"
                      id="view-data-btn"
                      class="btn btn-primary btn-block mt-2">
                View Data
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card shadow rounded">
        <div class="card-body" style="height: 700px; overflow-y: auto;">
          <div id="graph-container" class="container-fluid">
            <!-- Graph content will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    document.getElementById('view-data-btn').addEventListener('click', function() {
        const graphType = document.getElementById('graph').value;
        const department = document.getElementById('department').value;

        // Check if graph type is selected
        if (!graphType) {
            alert("Please select a graph type.");
            return;
        }

        // Build the URL with selected parameters based on graph type
        let url;
        if (graphType === 'ratings_trend') {
            url = new URL("{% url 'plot_ratings_trend' %}", window.location.origin);
            url.searchParams.append('department', department);  // Pass the selected department
        } else {
            url = new URL("{% url 'generate_graph' %}", window.location.origin);
            url.searchParams.append('graph', graphType);
            url.searchParams.append('department', department);
        }

        // Fetch the graph data
        fetch(url, {
            method: 'GET',
        })
        .then(response => response.text())
        .then(html => {
            document.getElementById('graph-container').innerHTML = html;
        })
        .catch(error => {
            console.error('Error fetching the graph:', error);
        });
    });
</script>

<script>
    document.getElementById('clear-filters-btn').addEventListener('click', function() {
        // Reset the filter selects to their default values
        document.getElementById('graph').selectedIndex = 0; // Reset graph select
        document.getElementById('department').selectedIndex = 0; // Reset department select
        document.getElementById('instructor').selectedIndex = 0; // Reset instructor select
        document.getElementById('course').selectedIndex = 0; // Reset course select

        // Clear the graph container
        document.getElementById('graph-container').innerHTML = '';
    });
</script>


{% endblock %}
